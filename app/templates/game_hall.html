{% extends "base.html" %}

{% block content %}
<h2>Phòng chờ trận #{{ game.id }}</h2>

<p>Chủ phòng: {{ game.player.playername }}</p>


<p id="opponent-info">
  {% if game.opponent %}
    Đối thủ: {{ game.opponent.playername }}
  {% elif game.ai %}
    Đối thủ (AI): {{ game.ai.name }}
  {% else %}
    <em>Chưa có đối thủ.</em>
  {% endif %}
</p>

<hr>

<p id="status-line">
  Trạng thái:
  {% if game.status == "pending" %}
    Đang chờ đối thủ
  {% elif game.status == "active" %}
    Sẵn sàng bắt đầu
  {% elif game.status == "canceled" %}
    Trận đã bị hủy
  {% endif %}
</p>

{% if invite_link %}
  <p>Link game</p>
  <p><code>{{ invite_link }}</code></p>
{% endif %}

  {% if current_user.playername == game.player.playername  %}
    <form method="POST">
        {{ start_form.hidden_tag() }}
        <button type="submit" name="action" value="start">Bắt đầu trận</button>
    </form>
  {% endif %}
    <form method="POST">
      {{ cancel_form.hidden_tag() }}
      <button type="submit" name="action" value="cancel">Hủy trận</button>
      </form>


<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
console.log("SocketIO script loaded");

const socket = io();
const gameId = "{{ game.id }}";

console.log(" Connecting to room:", gameId);

// Gửi yêu cầu tham gia phòng
socket.emit("join_room", { room: gameId });

// Khi tham gia phòng thành công, để check lỗi
socket.on("joined_room", (data) => {
    console.log(" Đã join room:", data);
});

// Khi có người khác vào phòng (cập nhật giao diện thôi)
socket.on("player_joined", (data) => {
    console.log(" Nhận event 'player_joined':", data);
    if (data.game_id == gameId) {
        console.log("Cập nhật giao diện đối thủ:", data.opponent_name);
        const opp = document.getElementById("opponent-info");
        if (opp) opp.innerHTML = "Đối thủ: " + (data.opponent_name || "Người chơi mới");

        const status = document.getElementById("status-line");
        if (status) status.innerHTML = "Trạng thái: Sẵn sàng bắt đầu";

        setTimeout(() => location.reload(), 1000);
    }
});

// Khi trận đấu bắt đầu
socket.on("game_started", (data) => {
    console.log("Nhận event game_started:", data);
    if (data.game_id == gameId) {
        window.location.href = data.redirect_url;
    }
});

// Khi trận đấu bị hủy
socket.on("game_canceled", (data) => {
    console.log(" Nhận event 'game_canceled':", data);
    if (data.game_id == gameId) {
        const status = document.getElementById("status-line");
        if (status) status.innerHTML = "Trạng thái: Trận đấu đã bị hủy!";
        const cancelForm = document.getElementById("cancel-form");
        if (cancelForm) cancelForm.style.display = "none";
    }
});

// Đối thủ rời đi
socket.on("opponent_left", (data) => {
    if (data.game_id == gameId) {
        console.log("Đối thủ đã rời phòng");
        console.log("opponent_left nhận được:", data);

        const opp = document.getElementById("opponent-info");
        if (opp) opp.innerHTML = "<em>Đối thủ đã rời đi.</em>";

        const status = document.getElementById("status-line");
        if (status) status.innerHTML = "Trạng thái: Đang chờ đối thủ";

    }
});

  
// Khi rời trang
//window.addEventListener("beforeunload", () => {
//    console.log("Rời trang → leave_room");
//    
//    socket.emit("leave_room", { room: gameId });
//});
</script>

{% endblock %}


